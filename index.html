
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Formation Télépilote Drone — FR 2025</title>
  <meta name="description" content="Réglementation EASA/DGAC — Catégories ouverte/spécifique/certifiée, STS-01/02, animations pédagogiques." />
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React & Babel CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    html, body { height: 100%; }
    .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    // Inline SVG icon components (minimal, no external deps)
    const Icon = {
      Play: (p)=> (<svg {...p} viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>),
      Pause: (p)=> (<svg {...p} viewBox="0 0 24 24" fill="currentColor"><path d="M6 5h4v14H6zM14 5h4v14h-4z"/></svg>),
      RotateCcw: (p)=> (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor"><path strokeWidth="2" d="M1 4v6h6"/><path strokeWidth="2" d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>),
      User: (p)=> (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="7" r="4" strokeWidth="2"/><path d="M5.5 21a8.38 8.38 0 0 1 13 0" strokeWidth="2"/></svg>),
      Users: (p)=> (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M17 21v-2a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2" strokeWidth="2"/><circle cx="9" cy="7" r="4" strokeWidth="2"/><path d="M23 21v-2a4 4 0 0 0-3-3.87" strokeWidth="2"/><path d="M16 3.13a4 4 0 0 1 0 7.75" strokeWidth="2"/></svg>),
      Eye: (p)=> (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" strokeWidth="2"/><circle cx="12" cy="12" r="3" strokeWidth="2"/></svg>),
      EyeOff: (p)=> (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M17.94 17.94A10.94 10.94 0 0 1 12 20C5 20 1 12 1 12a19.29 19.29 0 0 1 5.06-5.94" strokeWidth="2"/><path d="M10.58 10.58A3 3 0 0 0 7 12a3 3 0 0 0 5.24 1.76" strokeWidth="2"/><path d="m1 1 22 22" strokeWidth="2"/></svg>),
      AlertTriangle: (p)=> (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" strokeWidth="2"/><line x1="12" y1="9" x2="12" y2="13" strokeWidth="2"/><line x1="12" y1="17" x2="12.01" y2="17" strokeWidth="2"/></svg>),
      CheckCircle: (p)=> (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10" strokeWidth="2"/><path d="m9 12 2 2 4-4" strokeWidth="2"/></svg>),
      Info: (p)=> (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10" strokeWidth="2"/><line x1="12" y1="16" x2="12" y2="12" strokeWidth="2"/><line x1="12" y1="8" x2="12.01" y2="8" strokeWidth="2"/></svg>)
    };

    const ToggleSwitch = ({ checked, onChange, label }) => (
      <button
        type="button"
        onClick={() => onChange(!checked)}
        className={\`relative inline-flex h-6 w-11 items-center rounded-full transition-colors \${checked ? 'bg-green-600' : 'bg-gray-300'}\`}
        role="switch"
        aria-checked={checked}
      >
        <span className={\`inline-block h-5 w-5 transform rounded-full bg-white transition-transform \${checked ? 'translate-x-5' : 'translate-x-1'}\`} />
        <span className="sr-only">{label}</span>
      </button>
    );

    const GeoportalModal = ({ open, onClose }) => {
      if (!open) return null;
      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60">
          <div className="w-full max-w-5xl bg-white rounded-2xl shadow-2xl overflow-hidden">
            <div className="flex items-center justify-between px-4 py-3 border-b">
              <h4 className="font-bold text-lg">Zones du jour — Géoportail (UAS)</h4>
              <button onClick={onClose} className="px-3 py-1.5 rounded-md bg-gray-900 text-white hover:bg-gray-800">Fermer</button>
            </div>
            <div className="aspect-video">
              <iframe
                title="Géoportail UAS"
                src="https://www.geoportail.gouv.fr/carte"
                className="w-full h-full"
              ></iframe>
            </div>
            <div className="px-4 py-3 text-xs text-gray-600 border-t">
              Si la carte ne s’affiche pas (restrictions navigateur/CSP), ouvrez directement
              {' '}<a className="text-blue-700 underline" href="https://www.geoportail.gouv.fr/carte" target="_blank" rel="noreferrer">Géoportail</a>.
            </div>
          </div>
        </div>
      );
    };

    const CATEGORIES = {
      ouverte: {
        name: 'Catégorie Ouverte',
        description: 'Vols à faible risque, sans autorisation préalable (conditions strictes).',
        subcategories: {
          a1: {
            name: 'A1 — Survol de personnes',
            classes: 'C0 (< 250 g), C1 (< 900 g)',
            maxWeight: '900 g',
            minDistance: 'C1 : pas de survol intentionnel',
            maxHeight: '120 m AGL',
            requirements: 'C0 : aucune formation. C1 : formation A1/A3 en ligne (Fox AlphaTango).',
            zones: 'Zone peuplée possible (éviter les rassemblements).',
            remoteId: 'C0 : non — C1 : oui (Remote ID).',
            details: "C0 peut survoler des personnes isolées (éviter). C1 : pas de survol intentionnel de personnes non impliquées.",
          },
          a2: {
            name: 'A2 — Proximité de personnes',
            classes: 'C2 (< 4 kg)',
            maxWeight: '4 kg',
            minDistance: '30 m (ou 5 m en mode vitesse lente)',
            maxHeight: '120 m AGL',
            requirements: 'Certificat A2 (théorie) + autoformation pratique ; A1/A3 requis.',
            zones: 'Zone peuplée avec distances de sécurité.',
            remoteId: 'Obligatoire (C2).',
            details: 'Mode « vitesse lente » ≤ 3 m/s pour abaisser la distance mini à 5 m.',
          },
          a3: {
            name: 'A3 — Loin des personnes',
            classes: 'C2, C3, C4 (< 25 kg)',
            maxWeight: '25 kg',
            minDistance: '150 m des zones résidentielles/commerciales/industrielles',
            maxHeight: '120 m AGL',
            requirements: 'Formation A1/A3 en ligne (Fox AlphaTango).',
            zones: 'Zones non peuplées uniquement.',
            remoteId: 'C2 & C3 : oui — C4 : non.',
            details: 'Drones legacy 250 g–25 kg : A3 uniquement ; loin de toute personne non impliquée.',
          },
        },
      },
      specifique: {
        name: 'Catégorie Spécifique',
        description: 'Vols à risque moyen : déclaration/autorisation requise (scénarios standard).',
        subcategories: {
          sts01: {
            name: 'STS-01 (PDRA-S01)',
            classes: 'C5 (basé sur C3)',
            description: 'VLOS (à vue) sur zone au sol contrôlée, environnement possiblement peuplé.',
            maxHeight: '120 m',
            visualContact: 'À vue (VLOS)',
            zones: 'Zone contrôlée au sol (personnes non impliquées tenues à l’écart).',
            requirements: 'Formation A1/A3 + examen théorique catégorie ouverte (Fox) + conformité STS.',
            remoteId: 'Oui, obligatoire.',
            pilotDistance: '≥ 1 m entre télépilote et aéronef (schéma).',
            observerDistance: 'Observateur possible ; maintien de la zone contrôlée.',
            flightZone: 'Zone de vol typiquement ≤ 1 km (schéma pédagogique).',
            details: 'Respect du maintien des tiers hors zone ; opérations à vue avec mesures organisationnelles.',
          },
          sts02: {
            name: 'STS-02 (PDRA-S02)',
            classes: 'C6 (basé sur C3)',
            description: 'BVLOS hors vue avec observateurs, faible densité de population, zone contrôlée.',
            maxHeight: '120 m',
            visualContact: 'Hors vue (BVLOS) avec observateurs.',
            zones: 'Zone contrôlée au sol en environnement faiblement peuplé.',
            requirements: 'Formation et examen requis + conformité STS-02 ; procédures observateurs.',
            remoteId: 'Oui, obligatoire.',
            pilotDistance: 'Jusqu’à ~2 km du télépilote (schéma pédagogique).',
            observerDistance: 'Observateurs espacés (ex. ~1 km) pour continuité.',
            safetyDistance: 'Chaîne d’observateurs assurant la sécurité latérale.',
            flightZone: 'Segment BVLOS illustratif ≤ 2 km (schéma).',
            details: 'Opérations hors vue avec observateurs ; procédures de coordination et de communication.',
          },
        },
      },
      certifiee: {
        name: 'Catégorie Certifiée',
        description: 'Vols à haut risque : certification complète exigée (aéronef/opérateur/équipage).',
        subcategories: {
          certified: {
            name: 'Certified',
            description: 'Transport de personnes, survol d’assemblées, opérations complexes.',
            requirements: 'Aéronef, organisation et équipages certifiés (DGAC/EASA).',
            details: 'Drones lourds, missions cargo ou passagers ; agrément complet requis.',
          },
        },
      },
    };

    const DroneAnimation = ({ category, subcategory, progress, vlosMode, speedMultiplier = 1, schemaAnim = true }) => {
      const getDronePosition = () => {
        if (category === 'ouverte') {
          if (subcategory === 'a1') return { x: 100 + progress * 3, y: 100 + Math.sin(progress * 0.1) * 20 };
          if (subcategory === 'a2') return { x: 100 + progress * 3, y: 150 + Math.sin(progress * 0.1) * 15 };
          if (subcategory === 'a3') return { x: 100 + progress * 3.5, y: 80 + Math.sin(progress * 0.1) * 10 };
        } else if (category === 'specifique') {
          if (subcategory === 'sts01') return { x: 150 + progress * 2.5, y: 100 + Math.sin(progress * 0.15) * 25 };
          if (subcategory === 'sts02') return { x: 150 + progress * 3, y: 120 + Math.sin(progress * 0.12) * 20 };
        }
        return { x: 100, y: 100 };
      };

      const pos = getDronePosition();
      const showZones = category === 'specifique';
      const kmFactor = subcategory === 'sts02' ? 2 : subcategory === 'sts01' ? 1 : 0;
      const distanceKm = kmFactor ? (kmFactor * (progress / 100)).toFixed(2) : null;
      const durFast = (val) => \`\${(val / Math.max(speedMultiplier, 0.1)).toFixed(2)}s\`;

      return (
        <div className="relative w-full h-96 bg-gradient-to-b from-sky-200 via-sky-100 to-sky-50 rounded-lg overflow-hidden border-2 border-sky-300">
          <div className="absolute bottom-0 w-full h-24 bg-gradient-to-b from-green-300 to-green-400"></div>
          <div className="absolute top-10 right-20 w-16 h-16 bg-yellow-300 rounded-full opacity-70"></div>

          {category === 'specifique' && (
            <div className="absolute bottom-24 left-1/2 -translate-x-1/2">
              <svg width="200" height="120" viewBox="0 0 200 120" aria-hidden>
                <polygon points="40,120 100,20 160,120" fill="#94a3b8" opacity="0.6"></polygon>
                <polygon points="80,120 130,40 180,120" fill="#64748b" opacity="0.5"></polygon>
              </svg>
            </div>
          )}

          {showZones && subcategory === 'sts01' && (
            <svg className="absolute inset-0 pointer-events-none" aria-hidden>
              <defs>
                <marker id="arrow" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto">
                  <polygon points="0 0, 6 3, 0 6" fill="#22c55e"></polygon>
                </marker>
              </defs>
              <circle cx="80" cy="260" r="20" fill="rgba(34,197,94,0.08)" stroke="#16a34a" strokeWidth="1"></circle>
              <text x="80" y="244" textAnchor="middle" fontSize="9" fill="#166534">Zone intervention</text>
              <circle cx="80" cy="260" r="30" fill="rgba(59,130,246,0.06)" stroke="#2563eb" strokeWidth="1"></circle>
              <text x="80" y="232" textAnchor="middle" fontSize="9" fill="#1d4ed8">Zone tampon &lt;10 kg</text>

              <circle cx="80" cy="260" r="55" fill="rgba(34,197,94,0.10)" stroke="#22c55e" strokeWidth="2" strokeDasharray="5,5">
                {schemaAnim && <animate attributeName="r" values="55;60;55" dur={durFast(2)} repeatCount="indefinite" />}
                {schemaAnim && <animate attributeName="opacity" values="0.7;1;0.7" dur={durFast(2)} repeatCount="indefinite" />}
              </circle>
              <circle cx="80" cy="260" r="90" fill="rgba(59,130,246,0.08)" stroke="#3b82f6" strokeWidth="2" strokeDasharray="5,5">
                {schemaAnim && <animate attributeName="opacity" values="0.5;0.8;0.5" dur={durFast(3)} repeatCount="indefinite" />}
              </circle>
              <text x="80" y="200" textAnchor="middle" fill="#22c55e" fontSize="11" fontWeight="bold">Zone vol ~1 km</text>

              <path id="vlosPath" d="M 80 260 Q 180 220 260 160" fill="none" stroke="#22c55e" strokeWidth="2" strokeDasharray="6 6">
                {schemaAnim && <animate attributeName="stroke-dashoffset" from="0" to="-60" dur={durFast(1.2)} repeatCount="indefinite" />}
              </path>
              {schemaAnim && (
                <circle r="3" fill="#22c55e">
                  <animateMotion dur={durFast(2)} repeatCount="indefinite" rotate="auto">
                    <mpath xlinkHref="#vlosPath" />
                  </animateMotion>
                </circle>
              )}
            </svg>
          )}

          {showZones && subcategory === 'sts02' && (
            <svg className="absolute inset-0 pointer-events-none" aria-hidden>
              <defs>
                <marker id="arrow2" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto">
                  <polygon points="0 0, 6 3, 0 6" fill="#3b82f6"></polygon>
                </marker>
              </defs>
              <circle cx="80" cy="260" r="20" fill="rgba(34,197,94,0.08)" stroke="#16a34a" strokeWidth="1"></circle>
              <text x="80" y="244" textAnchor="middle" fontSize="9" fill="#166534">Zone intervention</text>
              <circle cx="80" cy="260" r="30" fill="rgba(59,130,246,0.06)" stroke="#2563eb" strokeWidth="1"></circle>
              <text x="80" y="232" textAnchor="middle" fontSize="9" fill="#1d4ed8">Zone tampon &lt;10 kg</text>

              <circle cx="80" cy="260" r="80" fill="rgba(34,197,94,0.08)" stroke="#22c55e" strokeWidth="2" strokeDasharray="5,5">
                {schemaAnim && <animate attributeName="opacity" values="0.6;0.9;0.6" dur={durFast(2.5)} repeatCount="indefinite" />}
              </circle>
              <circle cx="80" cy="260" r="120" fill="rgba(59,130,246,0.08)" stroke="#3b82f6" strokeWidth="2" strokeDasharray="5,5">
                {schemaAnim && <animate attributeName="r" values="115;120;115" dur={durFast(3)} repeatCount="indefinite" />}
              </circle>
              <text x="80" y="190" textAnchor="middle" fill="#22c55e" fontSize="11" fontWeight="bold">Zone vol ~2 km</text>

              <path id="bvlosPath" d="M 80 260 H 360" fill="none" stroke="#3b82f6" strokeWidth="2" strokeDasharray="6 6">
                {schemaAnim && <animate attributeName="stroke-dashoffset" from="0" to="-60" dur={durFast(1.2)} repeatCount="indefinite" />}
              </path>
              {schemaAnim && (
                <circle r="3" fill="#3b82f6">
                  <animateMotion dur={durFast(3)} repeatCount="indefinite" rotate="auto">
                    <mpath xlinkHref="#bvlosPath" />
                  </animateMotion>
                </circle>
              )}

              <line x1="200" y1="250" x2="200" y2="270" stroke="#1f2937" strokeWidth="2"></line>
              <text x="140" y="245" fill="#1f2937" fontSize="11" fontWeight="bold">1 km</text>
              <text x="260" y="245" fill="#1f2937" fontSize="11" fontWeight="bold">1 km</text>
            </svg>
          )}

          <div className="absolute bottom-28 left-12 text-center">
            <Icon.User className="w-10 h-10 text-blue-900 mx-auto" aria-hidden="true" />
            <div className="text-xs font-bold">Télépilote</div>
          </div>

          {subcategory !== 'a3' && subcategory !== 'sts02' && (
            <div className="absolute bottom-28 right-24 text-center">
              <Icon.Users className="w-14 h-14 text-blue-700 mx-auto" aria-hidden="true" />
              <div className="text-xs font-bold">Public</div>
            </div>
          )}

          {subcategory === 'sts02' && (
            <>
              <div className="absolute bottom-28 left-48 text-center">
                <Icon.User className="w-8 h-8 text-purple-700 mx-auto" aria-hidden="true" />
                <div className="text-xs font-bold">Obs 1</div>
              </div>
              <div className="absolute top-32 right-32 text-center">
                <Icon.User className="w-8 h-8 text-purple-700 mx-auto" aria-hidden="true" />
                <div className="text-xs font-bold">Obs 2</div>
              </div>
            </>
          )}

          {subcategory === 'a2' && (
            <svg className="absolute inset-0 pointer-events-none" aria-hidden>
              <line x1="80" y1="280" x2="230" y2="280" stroke="#22c55e" strokeWidth="2" strokeDasharray="5,5"></line>
              <text x="155" y="275" fill="#22c55e" fontSize="12" fontWeight="bold">30 m</text>
            </svg>
          )}

          {subcategory === 'a3' && (
            <svg className="absolute inset-0 pointer-events-none" aria-hidden>
              <line x1="80" y1="280" x2="450" y2="280" stroke="#ef4444" strokeWidth="2" strokeDasharray="5,5"></line>
              <text x="250" y="275" fill="#ef4444" fontSize="12" fontWeight="bold">150 m (zones habitées)</text>
            </svg>
          )}

          {category === 'specifique' && (
            <div className="absolute top-4 left-4 flex items-center gap-3 bg-white/90 px-3 py-2 rounded-lg shadow-md">
              {subcategory === 'sts01' ? (
                <>
                  <Icon.Eye className="w-5 h-5 text-green-600" aria-hidden="true" />
                  <span className="text-sm font-bold text-green-600">VLOS</span>
                </>
              ) : (
                <>
                  <Icon.EyeOff className="w-5 h-5 text-orange-600" aria-hidden="true" />
                  <span className="text-sm font-bold text-orange-600">BVLOS</span>
                </>
              )}
              {distanceKm !== null && (
                <span className="text-xs font-semibold text-gray-700 ml-2">Parcouru : {distanceKm} km</span>
              )}
            </div>
          )}

          {category === 'specifique' && (
            <div className="absolute top-4 right-4 flex items-center gap-2 bg-red-50 px-3 py-2 rounded-lg shadow-md border border-red-200">
              <Icon.AlertTriangle className="w-5 h-5 text-red-600" aria-hidden="true" />
              <span className="text-xs font-bold text-red-600">Risque tiers</span>
            </div>
          )}

          <div className="absolute right-6 top-6 bottom-24 flex items-center" aria-label="Hauteur maximale">
            <div className="h-full w-1 bg-green-600 relative">
              <div className="absolute -right-2 top-0 w-5 h-0.5 bg-green-600"></div>
              <div className="absolute -right-2 bottom-0 w-5 h-0.5 bg-green-600"></div>
            </div>
            <span className="ml-2 text-sm font-bold text-green-800">120 m</span>
          </div>

          {/* Drone (SVG) */}
          <svg
            className="absolute transition-transform duration-100"
            style={{ left: \`\${pos.x}px\`, top: \`\${pos.y}px\`, transform: 'translate(-50%, -50%)' }}
            width="50"
            height="50"
            viewBox="0 0 50 50"
            aria-label="Drone en déplacement"
          >
            <circle cx="25" cy="25" r="6" fill="#1e40af"></circle>
            <rect x="22" y="23" width="6" height="4" fill="#3b82f6"></rect>
            <line x1="12" y1="12" x2="25" y2="25" stroke="#1e40af" strokeWidth="3"></line>
            <line x1="38" y1="12" x2="25" y2="25" stroke="#1e40af" strokeWidth="3"></line>
            <line x1="12" y1="38" x2="25" y2="25" stroke="#1e40af" strokeWidth="3"></line>
            <line x1="38" y1="38" x2="25" y2="25" stroke="#1e40af" strokeWidth="3"></line>
            <circle cx="12" cy="12" r="5" fill="#ef4444" opacity="0.7">
              <animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="0.3s" repeatCount="indefinite" />
            </circle>
            <circle cx="38" cy="12" r="5" fill="#22c55e" opacity="0.7">
              <animateTransform attributeName="transform" type="rotate" from="0 38 12" to="360 38 12" dur="0.3s" repeatCount="indefinite" />
            </circle>
            <circle cx="12" cy="38" r="5" fill="#22c55e" opacity="0.7">
              <animateTransform attributeName="transform" type="rotate" from="0 12 38" to="360 12 38" dur="0.3s" repeatCount="indefinite" />
            </circle>
            <circle cx="38" cy="38" r="5" fill="#ef4444" opacity="0.7">
              <animateTransform attributeName="transform" type="rotate" from="0 38 38" to="360 38 38" dur="0.3s" repeatCount="indefinite" />
            </circle>
            <circle cx="25" cy="30" r="2" fill="#64748b"></circle>
          </svg>
        </div>
      );
    };

    const StatTile = ({ title, value, color = 'indigo' }) => (
      <div className={\`p-4 bg-\${color}-50 rounded-lg border-l-4 border-\${color}-500\`}>
        <p className="text-sm text-gray-600 font-semibold">{title}</p>
        <p className={\`text-lg font-bold text-\${color}-900\`}>{value}</p>
      </div>
    );

    const ResourceCard = ({ title, description, href }) => (
      <a
        href={href}
        target="_blank"
        rel="noreferrer"
        className="block bg-white/10 hover:bg-white/20 focus:bg-white/20 p-4 rounded-lg transition-colors outline-none"
      >
        <h4 className="font-bold mb-1">{title}</h4>
        <p className="text-sm opacity-90">{description}</p>
      </a>
    );

    function DroneTrainingApp() {
      const [selectedCategory, setSelectedCategory] = useState(localStorage.getItem('cat') || 'ouverte');
      const [selectedSubcategory, setSelectedSubcategory] = useState(localStorage.getItem('sub') || null);
      const [isAnimating, setIsAnimating] = useState(false);
      const [animationProgress, setAnimationProgress] = useState(0);
      const [showDetails, setShowDetails] = useState(false);
      const [isMavic3E, setIsMavic3E] = useState(false);
      const [showGeo, setShowGeo] = useState(false);
      const [environment, setEnvironment] = useState('peuplee'); // 'peuplee' | 'faible' | 'non'
      const [autoApplyEnv, setAutoApplyEnv] = useState(false);
      const [vlosMode, setVlosMode] = useState(true); // true = VLOS, false = BVLOS
      const [schemaAnim, setSchemaAnim] = useState(true);
      const [speedMultiplier, setSpeedMultiplier] = useState(1);

      useEffect(() => {
        localStorage.setItem('cat', selectedCategory);
        if (selectedSubcategory) localStorage.setItem('sub', selectedSubcategory);
      }, [selectedCategory, selectedSubcategory]);

      useEffect(() => {
        let interval;
        if (isAnimating) {
          interval = setInterval(() => {
            setAnimationProgress((prev) => (prev >= 100 ? 0 : Math.min(prev + 1 * speedMultiplier, 100)));
          }, 50);
        }
        return () => clearInterval(interval);
      }, [isAnimating, speedMultiplier]);

      const getEnvSuggestion = () => {
        if (environment === 'peuplee') {
          return { cat: 'ouverte', sub: 'a1', label: 'A1 (ouverte) — zone peuplée', alt: { cat: 'specifique', sub: 'sts01', label: 'STS‑01 (VLOS) — zone contrôlée' } };
        }
        if (environment === 'faible') {
          if (vlosMode) {
            return { cat: 'specifique', sub: 'sts01', label: 'STS‑01 (VLOS) — faiblement peuplée', alt: { cat: 'specifique', sub: 'sts02', label: 'STS‑02 (BVLOS) — avec observateurs' } };
          }
          return { cat: 'specifique', sub: 'sts02', label: 'STS‑02 (BVLOS) — faiblement peuplée', alt: { cat: 'specifique', sub: 'sts01', label: 'STS‑01 (VLOS) — alternative à vue' } };
        }
        return { cat: 'ouverte', sub: 'a3', label: 'A3 (ouverte) — zone non peuplée', alt: null };
      };

      useEffect(() => {
        if (!autoApplyEnv) return;
        const s = getEnvSuggestion();
        setSelectedCategory(s.cat);
        setSelectedSubcategory(s.sub);
        setIsAnimating(false);
        setAnimationProgress(0);
      }, [environment, vlosMode, autoApplyEnv]);

      const currentCategory = useMemo(() => CATEGORIES[selectedCategory], [selectedCategory]);
      const currentSubcategory = useMemo(() => (selectedSubcategory ? currentCategory.subcategories[selectedSubcategory] : null), [selectedSubcategory, currentCategory]);

      return (
        <div className="min-h-screen p-4">
          <div className="max-w-7xl mx-auto">
            <header className="text-center mb-4 bg-white rounded-2xl shadow-xl p-8">
              <h1 className="text-5xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-3">
                Formation Télépilote Drone
              </h1>
              <p className="text-xl text-gray-700 mb-2">Réglementation DGAC · EASA — France 2025</p>
              <p className="text-sm text-gray-500">Règlements (UE) 2019/947 et 2019/945</p>
            </header>

            {/* Barre outils */}
            <div className="mb-6 flex flex-col sm:flex-row items-stretch sm:items-center justify-between gap-3 bg-white rounded-xl shadow p-4">
              <div className="flex items-center gap-3 flex-wrap">
                <ToggleSwitch checked={isMavic3E} onChange={setIsMavic3E} label="Activer profil Mavic 3E (C1)" />
                <span className="text-sm font-semibold">Profil matériel : Mavic 3E (C1)</span>
                {isMavic3E && (
                  <span className="inline-flex items-center gap-1 text-xs px-2 py-1 rounded-full bg-green-100 text-green-800">
                    <Icon.CheckCircle className="w-4 h-4" /> actif
                  </span>
                )}
                <div className="h-6 w-px bg-gray-300 hidden sm:block"></div>
                <label className="text-sm font-semibold">Type d’environnement</label>
                <select
                  value={environment}
                  onChange={(e) => setEnvironment(e.target.value)}
                  className="text-sm border rounded-md px-2 py-1 bg-white"
                >
                  <option value="peuplee">Zone peuplée (urbaine)</option>
                  <option value="faible">Zone faiblement peuplée</option>
                  <option value="non">Zone non peuplée (rurale)</option>
                </select>
                {environment === 'faible' && (
                  <div className="flex items-center gap-2">
                    <span className="text-sm font-semibold">Mode</span>
                    <div className="flex items-center gap-1 bg-gray-100 rounded-md p-1">
                      <button
                        className={\`px-2 py-1 text-xs rounded \${vlosMode ? 'bg-white shadow font-bold' : 'opacity-70'}\`}
                        onClick={() => setVlosMode(true)}
                      >
                        VLOS
                      </button>
                      <button
                        className={\`px-2 py-1 text-xs rounded \${!vlosMode ? 'bg-white shadow font-bold' : 'opacity-70'}\`}
                        onClick={() => setVlosMode(false)}
                      >
                        BVLOS
                      </button>
                    </div>
                  </div>
                )}
                <label className="flex items-center gap-2 text-sm ml-1">
                  <input type="checkbox" checked={autoApplyEnv} onChange={(e) => setAutoApplyEnv(e.target.checked)} />
                  Appliquer automatiquement
                </label>
              </div>
              <div className="flex items-center gap-2">
                <button onClick={() => setShowGeo(true)} className="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">
                  Zones du jour (Géoportail)
                </button>
              </div>
            </div>

            {/* Panneau de suggestion selon l’environnement */}
            {(() => {
              const s = getEnvSuggestion();
              return (
                <div className="mb-6 rounded-xl border border-indigo-200 bg-indigo-50 p-4">
                  <div className="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                    <div className="text-sm text-indigo-900">
                      <p className="font-bold">Suggestion selon l’environnement :</p>
                      <p className="mt-1">{s.label}</p>
                      {s.alt && <p className="text-xs mt-1 opacity-80">Alternative : {s.alt.label}</p>}
                    </div>
                    {!autoApplyEnv && (
                      <div className="flex gap-2">
                        <button
                          onClick={() => { setSelectedCategory(s.cat); setSelectedSubcategory(s.sub); setIsAnimating(false); setAnimationProgress(0); }}
                          className="px-3 py-1.5 rounded-md bg-indigo-600 text-white hover:bg-indigo-700"
                        >
                          Appliquer la suggestion
                        </button>
                        {s.alt && (
                          <button
                            onClick={() => { setSelectedCategory(s.alt.cat); setSelectedSubcategory(s.alt.sub); setIsAnimating(false); setAnimationProgress(0); }}
                            className="px-3 py-1.5 rounded-md bg-white border hover:bg-gray-50"
                          >
                            Voir aussi : {s.alt.sub.toUpperCase()}
                          </button>
                        )}
                      </div>
                    )}
                  </div>
                </div>
              );
            })()}

            {isMavic3E && (
              <div className="mb-6 rounded-xl border border-amber-300 bg-amber-50 p-4">
                <div className="flex items-start gap-3">
                  <Icon.Info className="w-5 h-5 text-amber-600 mt-0.5" />
                  <div className="text-sm">
                    <p className="font-bold text-amber-900 mb-1">Rappels automatiques — Profil Mavic 3E (C1)</p>
                    <ul className="list-disc ml-5 space-y-1 text-amber-900">
                      <li><b>Classe C1</b> : <span className="font-medium">Remote ID requis</span>, étiquette de classe visible.</li>
                      <li><b>Usage conseillé</b> : {environment === 'non' ? 'A3 (ouverte) — non peuplée' : environment === 'faible' ? (vlosMode ? 'STS‑01 (VLOS) — zone contrôlée' : 'STS‑02 (BVLOS) — observateurs') : 'A1 (ouverte) — urbaine'}.</li>
                      <li><b>Hauteur</b> : 120 m AGL max (sauf dérogation STS/autorisation).</li>
                    </ul>
                    <div className="mt-3 flex flex-wrap gap-2">
                      <button onClick={() => { setSelectedCategory('ouverte'); setSelectedSubcategory('a1'); }} className="px-3 py-1.5 rounded-md bg-blue-600 text-white hover:bg-blue-700">Aller A1</button>
                      <button onClick={() => { setSelectedCategory('ouverte'); setSelectedSubcategory('a3'); }} className="px-3 py-1.5 rounded-md bg-blue-600 text-white hover:bg-blue-700">Aller A3</button>
                      <button onClick={() => { setSelectedCategory('specifique'); setSelectedSubcategory('sts01'); }} className="px-3 py-1.5 rounded-md bg-orange-600 text-white hover:bg-orange-700">Aller STS‑01</button>
                      <button onClick={() => { setSelectedCategory('specifique'); setSelectedSubcategory('sts02'); }} className="px-3 py-1.5 rounded-md bg-orange-600 text-white hover:bg-orange-700">Aller STS‑02</button>
                    </div>
                  </div>
                </div>
              </div>
            )}

            <GeoportalModal open={showGeo} onClose={() => setShowGeo(false)} />

            {/* Choix des catégories */}
            <div className="grid md:grid-cols-3 gap-4 mb-6">
              <button
                onClick={() => { setSelectedCategory('ouverte'); setSelectedSubcategory(null); setIsAnimating(false); }}
                aria-pressed={selectedCategory === 'ouverte'}
                className={\`p-6 rounded-xl shadow-lg transition-all hover:scale-105 focus:scale-105 focus:outline-none \${selectedCategory === 'ouverte' ? 'bg-blue-600 text-white scale-105' : 'bg-white text-blue-900 hover:bg-blue-50'}\`}
              >
                <Icon.CheckCircle className="w-8 h-8 mx-auto mb-2" />
                <h3 className="text-2xl font-bold mb-2">{CATEGORIES.ouverte.name}</h3>
                <p className="text-sm opacity-90">{CATEGORIES.ouverte.description}</p>
              </button>

              <button
                onClick={() => { setSelectedCategory('specifique'); setSelectedSubcategory(null); setIsAnimating(false); }}
                aria-pressed={selectedCategory === 'specifique'}
                className={\`p-6 rounded-xl shadow-lg transition-all hover:scale-105 focus:scale-105 focus:outline-none \${selectedCategory === 'specifique' ? 'bg-orange-600 text-white scale-105' : 'bg-white text-orange-900 hover:bg-orange-50'}\`}
              >
                <Icon.AlertTriangle className="w-8 h-8 mx-auto mb-2" />
                <h3 className="text-2xl font-bold mb-2">{CATEGORIES.specifique.name}</h3>
                <p className="text-sm opacity-90">{CATEGORIES.specifique.description}</p>
              </button>

              <button
                onClick={() => { setSelectedCategory('certifiee'); setSelectedSubcategory('certified'); setIsAnimating(false); }}
                aria-pressed={selectedCategory === 'certifiee'}
                className={\`p-6 rounded-xl shadow-lg transition-all hover:scale-105 focus:scale-105 focus:outline-none \${selectedCategory === 'certifiee' ? 'bg-red-600 text-white scale-105' : 'bg-white text-red-900 hover:bg-red-50'}\`}
              >
                <Icon.Info className="w-8 h-8 mx-auto mb-2" />
                <h3 className="text-2xl font-bold mb-2">{CATEGORIES.certifiee.name}</h3>
                <p className="text-sm opacity-90">{CATEGORIES.certifiee.description}</p>
              </button>
            </div>

            {/* Sous-catégories */}
            {selectedCategory !== 'certifiee' && (
              <div className={\`grid \${selectedCategory === 'ouverte' ? 'md:grid-cols-3' : 'md:grid-cols-2'} gap-4 mb-6\`}>
                {Object.entries(currentCategory.subcategories).map(([key, sub]) => (
                  <button
                    key={key}
                    onClick={() => { setSelectedSubcategory(key); setIsAnimating(false); setAnimationProgress(0); }}
                    aria-pressed={selectedSubcategory === key}
                    className={\`p-5 rounded-lg shadow-md transition-all hover:scale-105 focus:scale-105 focus:outline-none \${selectedSubcategory === key ? (selectedCategory === 'ouverte' ? 'bg-blue-500 text-white' : 'bg-orange-500 text-white') : 'bg-white hover:bg-gray-50'}\`}
                  >
                    <h4 className="font-bold text-lg mb-1">{sub.name}</h4>
                    <p className="text-xs opacity-90">{sub.description || sub.zones}</p>
                    {sub.classes && <p className="text-xs mt-2 font-semibold">Classes : {sub.classes}</p>}
                  </button>
                ))}
              </div>
            )}

            {/* Simulation & schémas */}
            {currentSubcategory && selectedCategory !== 'certifiee' && (
              <div className="bg-white rounded-xl shadow-xl p-6 mb-6">
                <div className="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between mb-4">
                  <h3 className="text-2xl font-bold text-gray-800">{currentSubcategory.name}</h3>
                  <div className="flex gap-2">
                    <button onClick={() => setIsAnimating(v => !v)} className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2 transition-all">
                      {isAnimating ? <Icon.Pause className="w-5 h-5" /> : <Icon.Play className="w-5 h-5" />}
                      {isAnimating ? 'Pause trajectoire' : 'Démarrer trajectoire'}
                    </button>
                    <button onClick={() => { setIsAnimating(false); setAnimationProgress(0); }} className="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-800 flex items-center gap-2 transition-all">
                      <Icon.RotateCcw className="w-5 h-5" />
                      Reset
                    </button>
                    <button onClick={() => setSchemaAnim(p => !p)} className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-all">
                      {schemaAnim ? 'Pause schémas' : 'Reprendre schémas'}
                    </button>
                  </div>
                </div>

                <DroneAnimation
                  category={selectedCategory}
                  subcategory={selectedSubcategory}
                  progress={animationProgress}
                  vlosMode={environment === 'faible' ? vlosMode : (selectedSubcategory === 'sts01' ? true : selectedSubcategory === 'sts02' ? false : undefined)}
                  speedMultiplier={speedMultiplier}
                  schemaAnim={schemaAnim}
                />
              </div>
            )}

            {/* Contrôles vitesse schémas */}
            <div className="bg-white rounded-xl shadow p-4 mb-6">
              <div className="flex items-center gap-3 text-sm">
                <label className="font-semibold">Vitesse schémas</label>
                <input type="range" min="0.5" max="3" step="0.1" value={speedMultiplier} onChange={(e) => setSpeedMultiplier(parseFloat(e.target.value))} />
                <span>{speedMultiplier.toFixed(1)}×</span>
              </div>
            </div>

            {/* Caractéristiques */}
            {currentSubcategory && (
              <div className="bg-white rounded-xl shadow-xl p-6 mb-6">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-2xl font-bold text-gray-800">Caractéristiques & Réglementation</h3>
                  <button onClick={() => setShowDetails(v => !v)} className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-all">
                    {showDetails ? 'Masquer' : 'Voir détails'}
                  </button>
                </div>

                <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                  {currentSubcategory.classes && (<StatTile title="Classes autorisées" value={currentSubcategory.classes} color="purple" />)}
                  {currentSubcategory.maxWeight && (<StatTile title="Masse maximale" value={currentSubcategory.maxWeight} color="blue" />)}
                  {currentSubcategory.minDistance && (<StatTile title="Distance minimale" value={currentSubcategory.minDistance} color="green" />)}
                  <StatTile title="Hauteur maximale" value={currentSubcategory.maxHeight || '120 m AGL'} color="indigo" />
                  {currentSubcategory.visualContact && (<StatTile title="Contact visuel" value={currentSubcategory.visualContact} color="teal" />)}
                  {currentSubcategory.remoteId && (<StatTile title="Remote ID" value={currentSubcategory.remoteId} color="pink" />)}

                  <div className="p-4 bg-yellow-50 rounded-lg border-l-4 border-yellow-500 md:col-span-2 lg:col-span-3">
                    <p className="text-sm text-gray-600 font-semibold mb-2">Zones autorisées</p>
                    <p className="text-sm font-bold text-yellow-900">{currentSubcategory.zones || 'Voir scénario / NOTAM'}</p>
                  </div>

                  <div className="p-4 bg-orange-50 rounded-lg border-l-4 border-orange-500 md:col-span-2 lg:col-span-3">
                    <p className="text-sm text-gray-600 font-semibold mb-2">Formation requise</p>
                    <p className="text-sm font-bold text-orange-900">{currentSubcategory.requirements || 'Selon classe/scénario'}</p>
                  </div>
                </div>

                {showDetails && (
                  <div className="mt-6 p-6 bg-gray-50 rounded-lg border border-gray-200">
                    <h4 className="font-bold text-lg mb-3 text-gray-800">Détails complémentaires</h4>
                    <p className="text-gray-700 mb-4">{currentSubcategory.details}</p>
                    {currentSubcategory.pilotDistance && (<div className="mb-2 text-sm"><span className="font-semibold">Distance télépilote–drone : </span>{currentSubcategory.pilotDistance}</div>)}
                    {currentSubcategory.observerDistance && (<div className="mb-2 text-sm"><span className="font-semibold">Distance observateur : </span>{currentSubcategory.observerDistance}</div>)}
                    {currentSubcategory.safetyDistance && (<div className="mb-2 text-sm"><span className="font-semibold">Distance de sécurité : </span>{currentSubcategory.safetyDistance}</div>)}
                    {currentSubcategory.flightZone && (<div className="mb-2 text-sm"><span className="font-semibold">Zone de vol : </span>{currentSubcategory.flightZone}</div>)}
                  </div>
                )}

                <p className="mt-4 text-xs text-gray-500">
                  ⚠️ Rappel : vérifiez toujours vos limitations locales (NOTAM, SUP AIP, zones UAS Géoportail),
                  et tenez compte des manuels fabricants.
                </p>
              </div>
            )}

            {/* Ressources officielles */}
            <div className="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl shadow-xl p-6 text-white mb-6">
              <h3 className="text-2xl font-bold mb-4">Ressources officielles</h3>
              <div className="grid md:grid-cols-3 gap-4">
                <ResourceCard title="AlphaTango" description="Enregistrement exploitant UAS" href="https://alphatango.aviation-civile.gouv.fr/" />
                <ResourceCard title="FOX AlphaTango" description="Formations et examens en ligne" href="https://fox-alphatango.aviation-civile.gouv.fr/" />
                <ResourceCard title="Géoportail – Zones UAS" description="Carte officielle des géozones" href="https://www.geoportail.gouv.fr/donnees/restrictions-pour-drones-de-loisir" />
              </div>
            </div>

            <footer className="text-center text-xs text-gray-500 pb-6">
              © 2025 — Support pédagogique simplifié — Vérifiez toujours la réglementation à jour.
            </footer>

            <GeoportalModal open={showGeo} onClose={() => setShowGeo(false)} />
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<DroneTrainingApp />);
  </script>
</body>
</html>
